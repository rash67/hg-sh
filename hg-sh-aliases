function _h-nb() {
  if [[ $2 != "" ]]; then
			hg update $2             
	fi
	
	hg bookmarks $1
}

function _h-repull() {
  bookmark=`hg bo | grep '*' | cut -f 3 -d' '`
	hg pull --rebase
	hg update $bookmark
}

function hg-alias() {
	local hg_alias=$1
	local hg_cmd=${2:-$hg_alias}  
	install-hg-completion $hg_alias $hg_cmd	
	alias $hg_alias="hg $hg_cmd"
}

install-hg-completion() {
  local cmd=$1
  local hg_cmd=$2

  function_name="_hg_complete_$cmd"  
  
  eval "function ${function_name}() {
    COMP_WORDS=('hg' \"${hg_cmd}\" \${COMP_WORDS[@]:1} )
    ((COMP_CWORD+=1))              
    let x=\$COMP_CWORD-1                                                    
    _hg \"hg\" \"\${COMP_WORDS[\$COMP_CWORD]}\" \"\${COMP_WORDS[\$x]}\"
  }
";
	complete -o bashdefault -o default -o nospace -F $function_name $cmd \
    || complete -o default -o nospace -F $function_name $cmd
  
}

hg_cmd_list=`hg help 2>&1 | sed -n -e '/enabled extensions/,$p' | egrep '^ \w+' | grep -v '\#'  |cut -f 2 -d' '`

for i in $hg_cmd_list; do 
  if [[ "$i" == "cat" ]]; then
    true
  else 
    #echo hg-alias $i $i
    hg-alias $i $i
  fi
done


hg_sh_path=$1
hg_cmd_alias_file="$hg_sh_path/hg-cmd-aliases"
for i in `grep '=' $hg_cmd_alias_file | cut -f 1 -d=`; do 
  #echo hg-alias $i $i
  hg-alias $i $i
done
                
#specific aliases that are different or that we want to induce tab-completion for
hg-alias br bookmark
hg-alias co update
hg-alias mg graft        
hg-alias st status
hg-alias s summary
hg-alias br bookmarks
hg-alias bk bookmarks
hg-alias l lg
hg-alias log lg
hg-alias shl shelve
hg-alias us unshelve
hg-alias au addremove
hg-alias rb rebase
hg-alias rslv resolve
hg-alias ev evolve
hg-alias uc uncommit

# alias where the 'hg <cmd>' is the same as the alias name (explicilty list)
hg-alias bookmark
hg-alias clean
hg-alias status
hg-alias sl
hg-alias pull
hg-alias resolve
hg-alias add         
hg-alias help
hg-alias rl
hg-alias heads
hg-alias diff
hg-alias show
hg-alias revert
hg-alias backout
hg-alias incoming

install-hg-completion rbc update

alias h=hg  
